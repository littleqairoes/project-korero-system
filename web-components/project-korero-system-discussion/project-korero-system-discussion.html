<!-- Polymer dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/uniflow-polymer/action-emitter.html">
<link rel="import" href="../../bower_components/uniflow-polymer/state-aware.html">
<link rel="import" href="../../bower_components/medium-editor-element/medium-editor-element.html">
<link rel="import" href="../../web-components/project-korero-system-new-discussion/project-korero-system-new-discussion.html">
<link rel="import" href="../../web-components/project-korero-system-icons/project-korero-system-icons.html">
<link rel="import" href="../../web-components/project-korero-system-behaviors/project-korero-system-utils-behavior.html">
<link rel="import" href="../../web-components/project-korero-system-behaviors/project-korero-system-user-behavior.html">
<link rel="import" href="../../web-components/project-korero-system-thumbnails/project-korero-system-thumbnails.html">

<link rel="import" href="project-korero-system-discussion-scripts.html">

<!-- Style dependency -->
<link rel="import" href="project-korero-system-discussion-style.html">

<dom-module id="project-korero-system-discussion">
  <template>
    <style is="custom-style" include="project-korero-system-discussion-style iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
    </style>



    <paper-material class="create-discussion-container" id="create-discussion-container">
      <template is="dom-if" if="[[newDiscussion]]">
        <project-korero-system-new-discussion id="new-discussion-block" user="[[user]]"></project-korero-system-new-discussion>
      </template>
    </paper-material>

    <!-- add thumbnails -->
    <template is="dom-if" if="{{viewThumbnailsBlock}}">
      <project-korero-system-thumbnails
        id="thumbnails-block">
      </project-korero-system-thumbnails>

    </template>

    <paper-fab
      id="create-discussion-button"
      icon="default:chat"
      on-tap="openCreateDiscussion">
    </paper-fab>
  </template>

  <script>
    Polymer({
      is: 'project-korero-system-discussion',

      properties: {
        newDiscussion: {
          type: Boolean,
          value: false
        },
        viewThumbnailsBlock: {
          type: Boolean
        }
      },

      behaviors: [
        KORERO.UtilsBehavior,
        KORERO.UserBehavior,
        UniFlow.ActionEmitter,
        UniFlow.StateAware
      ],

      observers: [
        'saveLinking(state.saveLinkingData, state.saveLinking)',
        'cancelLinking(state.cancelLinking)',
        'changeDiscussionTime(state.changeDiscussionTimeData, state.changeDiscussionTime)',
        'changeCommentTime(state.changeCommentTimeData, state.changeCommentTime)',
        '_closeThumbnailBlock(state.closeThumbnail)',
        '_openThumbnailBlock(state.openThumbnailBlockData, state.openThumbnailBlock)',
        '_saveDiscussion(state.saveDiscussion)'
      ],

      openCreateDiscussion: function() {
        this.newDiscussion = true;
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.$$('#new-discussion-block').newDiscussion();
          this.emitAction({
            type: KORERO.Actions.NEW_DISCUSSION
          })
        }.bind(this))
      },

      saveLinking: function(data) {
        if (data) {
          if (data.discussionid) {
            this.$$('#discussion-'+data.discussionid).saveLinking(data);
          } else if (this.newDiscussion) {
            this.$$('#new-discussion-block').saveLinking(data);
          }
        }
      },

      cancelLinking: function() {
        if (this.newDiscussion) {
          this.$$('#new-discussion-block').cancelLinking();
        }
      },

      changeDiscussionTime: function(data) {
        if (this.newDiscussion) {
          this.$$('#new-discussion-block').changeDiscussionTime(data);
        }
      },

      changeCommentTime: function(data) {
        if (data.discussionid) {
          this.$$('#discussion-'+data.discussionid).changeCommentTime(data);
        }
      },

      _openThumbnailBlock: function(data) {
        this.viewThumbnailBlock = true;
        this.permanentThumbnailBlock = data.open;
        Polymer.RenderStatus.AfterNextRender(this, function(){
          this.$$('#thumbnails-block').setNode(data.node, data.text, data.newDiscussion, data.open, data.discussionid, data.open);
        });
      },

      _closeThumbnailBlock: function() {
        this.$$('#thumbnails-block').setPrevious();
      },

      _permanentCloseThumbnailBlock: function(data) {
        if (this.viewThumbnailBlock) {
          this.$$('#thumbnails-block').setNode();
          this.viewThumbnailBlock = false;
        }
        if (this.viewNewDiscussionBlock) {
          this.$$('#new-discussion-block').closedThumbnailBlock();
        }

        if (data.discussionid) {
          this.$$('#discussion-'+data.discussionid).closedThumbnailBlock();
        }

      },
      _removeThumbnailBlock: function() {
        this.viewThumbnailBlock = false;
      },
      _openEditorOptions: function(e) {
        if (this.viewNewDiscussionBlock) {
          this.$$('#new-discussion-block').referMore();
        } else if (e.detail.discussionid) {
          this.$$('#discussion-'+e.detail.discussionid).referMore();
        }
      },

      cancelEditActivity: function() {
        this.$$('#new-discussion-block').cancelEditActivity();
      },
      saveEditActivity: function(data) {
        this.$$('#new-discussion-block').saveEditActivity(data);
      },

      cancelEditCommentActivity: function(data) {
        this.$$('#discussion-'+data.discussionid).cancelEditActivity();
      },
      saveEditCommentActivity: function(data) {
        this.$$('#discussion-'+data.discussionid).saveEditActivity(data);
      },



      _cancelDiscussion: function() {
        this.viewNewDiscussionBlock = false;
        this._permanentCloseThumbnailBlock();
        this.emitAction({
          type: KORERO.Actions.CLOSE_DISCUSSION
        });
      },
      _saveDiscussion: function() {
        this._cancelDiscussion();
      },

      _hideContainer: function(state) {
        return !state ? 'hidden' : '';
      }
    });
  </script>
</dom-module>

<!-- Polymer dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/uniflow-polymer/action-emitter.html">
<link rel="import" href="../../bower_components/uniflow-polymer/state-aware.html">
<link rel="import" href="../../bower_components/medium-editor-element/medium-editor-element.html">
<link rel="import" href="../../web-components/project-korero-system-icons/project-korero-system-icons.html">
<link rel="import" href="../../web-components/project-korero-system-behaviors/project-korero-system-utils-behavior.html">

<!-- Style dependency -->
<link rel="import" href="project-korero-system-new-discussion-style.html">

<dom-module id="project-korero-system-new-discussion">
  <template>
    <style is="custom-style" include="project-korero-system-new-discussion-style iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
    </style>
    <paper-material>
      <div class="new-discussion-time">
        <template is="dom-if" if="{{!discussion.videolink}}">
          Global: <iron-icon icon="default:language"></iron-icon>
        </template>
        <template is="dom-if" if="{{discussion.videolink}}">
          Specific: <iron-icon icon="default:radio-button-checked"></iron-icon> [[_timeToString(discussion.start)]] - [[_timeToString(discussion.end)]]
        </template>
      </div>

      <div class="new-discussion-container">

        <paper-material class$="toolbar [[hideContainer(viewOptions)]]" elevation="2"></paper-material>
        <paper-material class$="toolbar-refer [[hideContainer(viewRefer)]]" elevation="2">
          <b>Reference this term to:</b><br/>
          <template is="dom-if" if="{{isKorero(ui)}}">
            <paper-button raised on-tap="linkvideo">This Lecture Video</paper-button><br/>
          </template>
          <!--<paper-button raised>Other Course Materials</paper-button><br/>-->
          <paper-input label="Link other PDF materials" accept="application/pdf" id="external" type="file"></paper-input>
          <paper-button raised on-tap="_createLink">Upload Materials</paper-button><br/>
        </paper-material>

        <paper-input label="Thread title here..." id="title"></paper-input>

        <div id="body" on-tap="commentChange" on-track="commentChange" on-keydown="commentChange">
          This is a text
        </div>

        <div class="buttons">
          <paper-button raised on-tap="cancel">
            Cancel
          </paper-button>
          <paper-button raised on-tap="post">
            Post
          </paper-button>
        </div>
      </div>

      <template is="dom-if" if="{{viewThumbnailBlock}}">
        <thumbnails-block
          id="thumbnails-block"
          on-close-thumbnails-block="_mouseoutNode"
          >
        </thumbnails-block>
      </template>

    </paper-material>
  </template>

  <script>
    Polymer({
      is: 'project-korero-system-new-discussion',

      properties: {
        discussion: {
          type: Object,
        },
        selected: {
          type: Object
        },
        node: {
          type: Object
        },
        viewOptions: {
          type: Boolean,
          value: false
        },
        viewRefer: {
          type: Boolean,
          value: false
        },
        videoid: String,
        ui: String,
        user: {
          type: Object
        },
        viewThumbnailBlock: {
          type: Boolean,
          value: false
        },
        task: {
          type: String
        },
        _createNode: {
          type: Object
        }
      },

      behaviors: [
        KORERO.UtilsBehavior,
        UniFlow.ActionEmitter,
        UniFlow.StateAware
      ],

      observers: [
        'saveLinking(state.saveLinking, state.discussionId)'
      ],

      attached: function() {
        var el = this.$$('#body');

        var buttons = ['bold', 'italic', 'underline', 'refer-extension'];
        var referExtension = this.referExtension();

        var options = {
          autoLink: true,
          toolbar: {
            /* These are the default options for the toolbar,
              if nothing is passed this is what is used */
            allowMultiParagraphSelection: true,
            buttons: buttons,
          },
          extensions: {
            'refer-extension': new referExtension()
          }
        }

        this._editor = new MediumEditor(el, options);

        var editorAnchor = window.document.getElementById('medium-editor-anchor-preview-1');
        var editorToolbar = window.document.getElementById('medium-editor-toolbar-1');
        this.$$('.toolbar').appendChild(editorAnchor);
        this.$$('.toolbar').appendChild(editorToolbar);
      },

      _editor: null,

      newDiscussion: function() {
        this.discussion = {
          title: '',
          text: '',
          nodes: {},
          videolink: false,
          ui: this.ui
        };
        this.$$('#title').value = '';
        this._editor.setContent('', 0);
      },

      commentChange: function() {
        if (this.node) {
          this.checkNode();
        }
        this.selected = this.showSelectionDiv();
        this.viewOptions = true;
        this.viewRefer = false;
        this.openHover();
      },

      checkNode: function() {
        console.log(this.node)
        if (this.node) {
          var nodeId = this.node.id;
          var hasNode = false;
          for (var i in this.discussion.nodes[nodeId].refers) {
            if (this.discussion.nodes[nodeId].refers[i]) {
              hasNode = true;
              break;
            }
          }
          // console.log(hasNode, this.selected)
          if (!hasNode && this.selected) {
            this.selected.range.deleteContents();
            this.selected.range.insertNode(document.createTextNode(this.node.innerHTML));
            this.selected = null;
            this.emitAction({
              type: KORERO.Actions.CLOSE_EDIT_ACTIVITY
            })
            this.node = null;
          } else {
            this.emitAction({
              type: KORERO.Actions.CLOSE_THUMBNAIL
            })
          }
        }
      },

      referExtension: function() {
        var self = this;
        return MediumEditor.Extension.extend({
          name: 'refer-extension',

          init: function () {
            this.button = this.document.createElement('button');
            this.button.classList.add('medium-editor-action');
            this.button.innerHTML = '<iron-icon icon="default:insert-drive-file"></iron-icon>';
            this.on(this.button, 'click', this.handleClick.bind(this));
          },

          getButton: function () {
            return this.button;
          },

          handleClick: function(event) {
            // console.log(self.state.discusssionSelected);
            // console.log(self.state.discussionSelected.text)
            // self.debounce('refer', self.refer, 500);
            self.refer();
          }
        })
      },

      refer: function() {
        var selected = this.selected
        if (selected && selected.text && selected.text.length > 0) {
          var id = 'discussion-link-' + chance.string({pool: 'abcdefghijklmnopqrstuvwxyz', length: 10});
          var text = selected.text;
          this._editor.pasteHTML('<mark id=' + id + '>' + text + '</mark>&#8203;');
          this.$$('#' + id).classList.add('new-discussion-link');
          this.node = this.$$('#' + id);
          this.discussion.nodes[id] = {
            refers: {}
          };
          this.viewOptions = false;
          this.viewRefer = true;
          // this.emitAction({type: KORERO.Actions.SET_REFER_VIEW, referView: true});
          // this.emitAction({type: KORERO.Actions.SET_NEW_DISCUSSION_LINKS, id: id})
        }
      },

      referMore: function() {
        console.log('refer mmore')
        this.viewOptions = false;
        this.viewRefer = true;
        // this.refer(true);
      },

      openHover: function(flag) {
        var selected = this.selected;
        if (this.selected.text && this.selected.text.length > 0) {
          var elRect = this.$$('.new-discussion-container').getBoundingClientRect();
          var top = (selected.pos.top - elRect.top) + selected.pos.height;
          var left = (selected.pos.left) - elRect.left;
          if (elRect.width - left < 200) {
            left = elRect.width - 200;
          }
          this.$$('.toolbar').setAttribute('style', `top: ${top}px; left: ${left}px`);
          this.$$('.toolbar-refer').setAttribute('style', `top: ${top}px; left: ${left}px`);

          // if (!flag) this.refer();
        } else {
          this.viewOptions = false;
          this.viewRefer = false;
        }
      },

      createLink: function() {
        if (this.ui === 'korero') {
          KORERO.Elements.Template.$.toast.showMessage('Uploading...');
          this.emitAction({
            type: KORERO.Actions.READY_EDIT_ACTIVITY
          })
          var file = this.$$('#external').inputElement.files[0];

          var task = firebase.storage().ref('docs/'+ this.state.interfaceId +'/'+file.name).put(file);
          task.on('state_changed', function(snapshot){

          }, this._catchError.bind(this), function() {
            KORERO.Elements.Template.$.toast.showMessage('Uploading done');
            PDFJS.getDocument(task.snapshot.downloadURL).then(function(pdf) {

              this.emitAction({
                type: KORERO.Actions.EDIT_ACTIVITY,
                data: {
                  pdf: pdf,
                  file: task.snapshot.downloadURL
                }
              });
              this.$$('#external').inputElement.value = '';
              this.viewOptions = false;
              this.viewRefer = true;
            }.bind(this))
            // console.log();
          })
        } else {
          this.viewOptions = false;
          this.viewRefer = false;
          var nodeId = this.node.id;
          var referId = null;

          do {
            referId = chance.string({pool: 'abcdefghijklmnopqrstuvwxyz', length: 10});
          } while (this.discussion.nodes[nodeId].refers[referId]);

          var task = firebase.storage().ref('docs/'+ this.state.interfaceId +'/'+file.name).put(file);
          task.on('state_changed', function(snapshot){

          }, this._catchError.bind(this), function() {
            KORERO.Elements.Template.$.toast.showMessage('Uploading done');

            this.discussion.nodes[nodeId].refers[referId] = {
              file: task.snapshot.downloadURL,
              boxes: {
                root: {
                  id: 'root',
                  page: 1
                }
              }
            };

            this.node.classList = ['hover'];
            this.node.addEventListener('mouseover', this._mouseoverNode.bind(this));
            // this.node.addEventListener('mouseout', this._mouseoutNode.bind(this));
            this.node.addEventListener('tap', this._tapNode.bind(this));
            this.node = null;
            // console.log();
          })
        }
      },

      hideContainer: function(state) {
        return !state ? 'hidden' : '';
      },

      linkvideo: function() {
        this.emitAction({
          type: KORERO.Actions.START_LINKING
        });

        this.viewOptions = false;
        this.viewRefer = false;

      },

      cancelEditActivity: function() {
        this.checkNode();
      },

      saveEditActivity: function(data) {
        var nodeId = this.node.id;
        var referId = null;
        do {
          referId = chance.string({pool: 'abcdefghijklmnopqrstuvwxyz', length: 10});
        } while (this.discussion.nodes[nodeId].refers[referId]);
        // console.log(data);
        this.discussion.nodes[nodeId].refers[referId] = data;

        this.emitAction({
          type: KORERO.Actions.OPEN_THUMBNAIL_BLOCK,
          data: {node: this.discussion.nodes[nodeId], text: this.node.innerHTML, newDiscussion: true, open: true}
        })
      },

      saveLinking: function(data) {
        var nodeId = this.node.id;
        var referId = null;
        do {
          referId = chance.string({pool: 'abcdefghijklmnopqrstuvwxyz', length: 10});
        } while (this.discussion.nodes[nodeId].refers[referId]);
        this.discussion.nodes[nodeId].refers[referId] = {
          boxes: {
            root: data
          }
        };

        console.log('savelinking-new-discussion')

        this.emitAction({
          type: KORERO.Actions.OPEN_THUMBNAIL_BLOCK,
          data: {node: this.discussion.nodes[nodeId], text: this.node.innerHTML, newDiscussion: true, open: true}
        });
      },

      closedThumbnailBlock: function() {
        if (this.node) {
          var nodeId = this.node.id;
          var flag = false;
          // console.log(this.discussion.nodes[nodeId]);
          for (var i in this.discussion.nodes[nodeId].refers) {
            if (this.discussion.nodes[nodeId].refers[i]) {
              flag = true;
              break;
            }
          }
          if (flag) {
            this.node.classList = ['hover'];
            this.node.addEventListener('mouseover', this._mouseoverNode.bind(this));
            // this.node.addEventListener('mouseout', this._mouseoutNode.bind(this));
            this.node.addEventListener('tap', this._tapNode.bind(this));
            this.node = null;
          }
          // } else {
          //   // delete(this.discussion.nodes[nodeId]);
          // }
        }
      },

      _mouseoverNode: function(e) {
        this._mouseoutNode();
        if (this.ui === 'korero') {
          var nodeId = e.target.id;
          var element = e.target;
          var box = e.target.getBoundingClientRect();
          // console.log(box);
          var node = this.discussion.nodes[nodeId];
          this.viewThumbnailBlock = true;
          this.async(function(){
            this.$$('#thumbnails-block').setNode(node, element.innerHTML, false, false);
            this.$$('#thumbnails-block').setAttribute('style', `left: ${box.left - 200}px; top: ${box.top + 20}px; z-index: 100`);
          }.bind(this), 100);
          // this.fire('mouseover-node', {node: node, text: e.target.innerHTML});
        }
      },
      _mouseoutNode: function(e) {
        if (this.viewThumbnailBlock) {
          this.$$('#thumbnails-block').setNode();
        }
        this.viewThumbnailBlock = false;
        // this.fire('mouseout-node', {});
      },

      _tapNode: function(e) {
        this._mouseoutNode();
        var nodeId = e.target.id;
        var node = this.discussion.nodes[nodeId];
        if (this.isKorero(this.ui)) {
          this.closedThumbnailBlock();

          this.emitAction({
            type: KORERO.Action.CLOSE_EDIT_ACTIVITY
          });
          this.emitAction({
            type: KORERO.Action.TAP_NODE,
            data: {node: node, text: e.target.innerHTML, open: true}
          });
        } else {
          for (var i in node.refers) {
            if (node.refers[i]) {
              window.open(node.refers[i].file);
              break;
            }
          }
        }
      },

      changeDiscussionTime: function(data) {
        console.log(data);
        if (data.discussionstart != undefined || data.discussionstart != null) {
          this.set('discussion.videolink', true);
          // this.discussion.videolink = true
        } else {
          this.set('discussion.videolink', false);
          // this.discussion.videolink = false
        }
        this.set('discussion.start', data.discussionstart);
        this.set('discussion.end', data.discussionend);
        // this.discussion.start = data.discussionstart;
        // this.discussion.end = data.discussionend;
        console.log(this.discussion)
      },

      cancel: function() {
        this.viewOptions = false;
        this.viewRefer = false;
        this.emitAction({
          type: KORERO.Actions.CANCEL_DISCUSSION
        })
      },

      post: function() {
        this.closedThumbnailBlock();
        // console.log(this.$$('#text').innerHTML)
        this.set('discussion.title', this.$$('#title').value);
        console.log(this._editor.getContent(0))
        this.set('discussion.text', this._editor.getContent(0));
        // this.set('discussion.text', this.$$('#text').innerHTML);
        this.set('discussion.user', this.user.uid);
        this.set('discussion.task', this.task);
        this.set('discussion.createdOn', this.getUTC());

        if (this.user.displayName) {
          this.set('discussion.participantNumber', this.user.displayName);
        }
        var ref = this.discussion.videolink ? this.interfacePath.discussions + '/' + this.videoid + '/specifics/specifics-' + chance.string({pool: 'abcdefghijklmnopqrstuvwxyz', length: 20}) :
          this.interfacePath.discussions + '/' + this.videoid + "/discussion/discussion-" + this.ui + "-" + chance.string({pool: 'abcdefghijklmnopqrstuvwxyz', length: 20})

        firebase.database().ref(ref).set(this.discussion).then(function(){
          KORERO.Elements.Template.$.toast.showMessage('Saved...');
          this.viewOptions = false;
          this.viewRefer = false;
          this.emitAction({
            type: KORERO.Actions.SAVE_DISCUSSION
          })
        }.bind(this)).catch(this._catchError.bind(this));
      },
      _removeThumbnailBlock: function() {

      },

    });
  </script>
</dom-module>

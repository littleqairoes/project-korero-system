<!-- Polymer dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/uniflow-polymer/action-emitter.html">
<link rel="import" href="../../bower_components/uniflow-polymer/state-aware.html">
<link rel="import" href="../../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../web-components/project-korero-system-icons/project-korero-system-icons.html">
<link rel="import" href="../../web-components/project-korero-system-behaviors/project-korero-system-utils-behavior.html">
<link rel="import" href="../../web-components/project-korero-system-behaviors/project-korero-system-interface-behavior.html">


<!-- Style dependency -->
<link rel="import" href="project-korero-system-video-style.html">

<dom-module id="project-korero-system-video">
  <template>
    <style is="custom-style" include="project-korero-system-video-style iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
      }
    </style>

    <firebase-document path="[[interfacePath.videos]]/[[state.interfaceId]]" data="{{video}}"></firebase-document>

    <!--<template is="dom-if" if="[[video.videoId]]">-->
      <div class="container" id="container-panel">
        <div class="horizontal layout center">
          <div class="flex" id="container-video">
            <google-youtube
                width="100%"
                id="video-content"
                video-id="[[video.videoId]]"
                chromeless
                on-google-youtube-ready="videoReady"
                on-google-youtube-state-change="stateChange"
                currenttime="{{videotime}}"
                duration="{{videoduration}}"
                currenttimeformatted="{{videoShowTime}}"></google-youtube>

            <div class="horizontal layout center" id="video-content-player-area">

              <paper-icon-button icon="default:play-circle-outline" on-tap="play"></paper-icon-button>
              <paper-icon-button icon="default:pause-circle-outline" on-tap="pause"></paper-icon-button>

              <div class="flex scrubber-area" on-down="scrub" on-track="scrub" id="video-scrubber-area">
                <div class="scrubber-grey">
                  <div id="video-play-time"></div>

                  <template is="dom-if" if="[[checkGeneral(linkVideoStart, linkingEdit)]]">
                    <div class="linker-play-time"></div>
                  </template>

                  <div id="linking-play-time"></div>
                  <div id="show-linking-play-time"></div>
                  <div id="discussion-play-time"></div>
                  <div id="comment-play-time"></div>
                  <div id="specific-play-time"></div>

                  <template is="dom-if" if="[[visualstart]]">
                    <div id="start-play-time">
                      [[visualstart]]
                    </div>
                  </template>
                  <template is="dom-if" if="[[visualend]]">
                    <div id="end-play-time">
                      [[visualend]]
                    </div>
                  </template>
                </div>

                <google-youtube
                  width="160px"
                  height="90px"
                  id="video-thumbnail"
                  video-id="[[video.videoId]]"
                  chromeless
                  on-google-youtube-ready="videoThumbnailReady">
                </google-youtube>
              </div>

              <div class="video-show-time">
                {{videoShowTime}}
              </div>
            </div>

            <template is="dom-if" if="{{linking}}">
              <div class="horizontal layout">
                <div class="flex"></div>

                <template is="dom-if" if="{{linkingEdit}}">
                  <paper-icon-button
                    id="linking-ok"
                    icon="default:check"
                    on-tap="saveLinking"></paper-icon-button>
                </template>

                <paper-icon-button
                  id="linking-cancel"
                  icon="default:close"
                  on-tap="cancelLinking"></paper-icon-button>

                <template is="dom-if" if="{{linkingEdit}}">
                  <paper-button
                    on-tap="addSegment">
                    + Add one more segment
                  </paper-button>
                </template>

                <div class="flex"></div>
              </div>
            </template>

            <template is="dom-if" if="{{playspecific}}">
              <div class="horizontal layout">
                <div class="flex"></div>

                <paper-icon-button
                  id="specific-cancel"
                  icon="deafult:close"
                  on-tap="_cancelSpecific"></paper-icon-button>

                <div class="flex"></div>
              </div>
            </template>
          </div>
        </div>
      </div>
    <!--</template>-->

  </template>

  <script>
    Polymer({
      is: 'project-korero-system-video',

      properties: {
        videotime: {
          type: Number,
          observer: "changeVideoTime"
        },
        videoid: {
          type: String
        },
        videoShowTime: {
          type: String
        },
        videoduration: {
          type: Number
        },
        linking: {
          type: Boolean
        },
        showLinkingFlag: {
          type: Boolean
        },
        linkingEdit: {
          type: Boolean
        },
        linkVideoStart: {
          type: Number
        },
        showLinkingVideoStart: {
          type: Number
        },
        linkVideoEnd: {
          type: Number
        },
        showLinkingVideoEnd: {
          type: Number
        },
        playspecific: {
          type: Boolean
        },
        discussionstart: {
          type: Number
        },
        discussionend: {
          type: Number
        },
        playstart: {
          type: Number
        },
        playend: {
          type: Number
        },
        visualstart: {
          type: Number
        },
        visualend: {
          type: Number
        },
        videoLoaded: {
          type: Boolean,
          value: false
        },
        canvas: {
          type: Object
        },
        boxes :{
          type: Object
        }
      },

      behaviors: [
        KORERO.UtilsBehavior,
        KORERO.InterfaceBehavior,
        UniFlow.ActionEmitter,
        UniFlow.StateAware
      ],

      observers: [
        // '_newDiscussion(state.createDiscussion)',
        // '_newComment(state.createComment)',
        // '_playSpecific(state.playspecific)',
        // '_startLinking(state.linking, state.linkingEdit, state.linkTapped)',
        // '_showLinking(state.showLinkingFlag, state.linkTapped, state.showLinkingTime.start, state.showLinkingTime.end)',
        'setVideo(video.videoId)'
      ],

      resizeBind: null,

      attached: function() {
        this.resize();
        this.resizeBind = this.resizeBind || this.resize.bind(this);
        window.addEventListener('resize', this.resizeBind);
      },

      detached: function() {
        window.removeEventListener('resize', this.resizeBind);
      },

      setVideo: function(id) {
        console.log(id)
        this.emitAction({
          type: KORERO.Actions.SET_VIDEO,
          videoId: id
        });
      },

      resize: function() {
        var height = ((this.$$('#video-content').getBoundingClientRect().width * 9) / 16)
        this.$$('#video-content').setAttribute('height', `${height}px`);
      },

      play: function() {
        this.$$('#video-content').play()
      },

      pause: function() {
        if (this.$$('#video-content')) {
          this.$$('#video-content').pause()
        }

      },

      scrub: function(e) {
        e.preventDefault();
        var el = this.$$('#video-scrubber-area');
        var elRect = el.getBoundingClientRect();
        var scrubPos = (e.detail.x - elRect.left) / elRect.width
        scrubPos = scrubPos <= 0 ? 0 : scrubPos;
        scrubPos = scrubPos >= 1 ? 1 : scrubPos;
        this.$$('#video-thumbnail').setAttribute('style', `display: block; left: ${scrubPos * 100}%; top: -105px`);

        var time = this.videoduration * scrubPos
        this.$$('#video-thumbnail').seekTo(time);
        this.$$('#video-thumbnail').play();

        if (this.linking) {
          this.linkVideoStart = time;
          this.linkVideoEnd = time;
          this.visualstart = this._timeToString(time);
          this.visualend = this._timeToString(time);
          this.changeLinkVideoTime();
          this.$$('#video-content').seekTo(time);
        } else if (this.discussionLink) {
          this.discussionstart = time;
          this.discussionend = time;
          this.visualstart = this._timeToString(time);
          this.visualend = this._timeToString(time);
          this.changeDiscussionTime();
          this.$$('#video-content').seekTo(time);
        } else if (this.state.commentLink) {
          this.commentstart = time;
          this.commentend = time;
          this.visualstart = this._timeToString(time);
          this.visualend = this._timeToString(time);
          this.changeCommentTime();
          this.$$('#video-content').seekTo(timet);
        } else {
          this.changeVideoTime(time);
          this.$$('#video-content').seekTo(this.videoduration != 1 ? this.videoduration * scrubPos : 0);
        }

       this.debounce('close-thumbnail-video', this.closeThumbnailVideo.bind(this), 1000);

      },

      closeThumbnailVideo: function() {
        this.$$('#video-thumbnail').pause();
        this.$$('#video-thumbnail').setAttribute('style', 'display: none');
      },


      videoReady: function(e) {
        this.resize();
        this.play();
      },

      videoThumbnailReady: function() {
        // this.$$('#video-thumbnail').setPlaybackQuality('tiny');
        this.$$('#video-thumbnail').play();
        this.$$('#video-thumbnail').mute();
      },

      stateChange: function(e) {
        if (!this.videoLoaded && e.detail.data) {
          this.videoLoaded = true;
        }
        if (e.detail.data === 1 && this._playspecific) {
          this.changeSpecificTime();
        }
      },

      changeVideoTime: function(time) {
        var elPlayTime = this.$$('#video-play-time');

        if (!elPlayTime) {
          return;
        }
        elPlayTime.setAttribute('style', `width: ${(time/this.videoduration)*100}%`);
        // console.log(this.linking, this.showLinkingFlag)
        if (this.linking) {
          if (time >= this.linkVideoEnd) {
            this.$$('#video-content').seekTo(this.linkVideoStart);
            this.play();
          } else if (time < this.linkVideoStart) {
            this.$$('#video-content').seekTo(this.linkVideoStart);
            this.play();
          }
        } else if (this.discussionlink) {
          if (time >= this.discussionend) {
            this.$$('#video-content').seekTo(this.discussionstart);
            this.play();
          } else if (time < this.discussionstart) {
            this.$$('#video-content').seekTo(this.discussionstart);
            this.play();
          }
        } else if (this.playspecific) {
          if (this.playstart != null || this.playstart != undefined) {
            if (time >= this.playend) {
              this.$$('#video-content').seekTo(this.playstart);
              this.play();
            } else if (time < this.playstart) {
              this.$$('#video-content').seekTo(this.playstart);
              this.play();
            }
          } else if (time < 0 || time >= this.videoduration){
             this.$$('#video-content').seekTo(0);
             this.play();
          }

        } else if (this.showLinkingFlag) {
          if (this.showLinkingVideoStart != null || this.showLinkingVideoStart != undefined) {
            if (time >= this.showLinkingVideoEnd) {
              this.$$('#video-content').seekTo(this.showLinkingVideoStart);
              this.play();
            } else if (time < this.showLinkingVideoStart) {
              this.$$('#video-content').seekTo(this.showLinkingVideoStart);
              this.play();
            }
          } else if (time < 0 || time >= this.videoduration){
             this.$$('#video-content').seekTo(0);
             this.play();
          }
        }

      },

      changeLinkVideoTime: function() {
        var elPlayTime = this.$$('#linking-play-time');
        elPlayTime.setAttribute('style', `left: ${(this.linkVideoStart/this.videoduration)*100}%; width: ${((this.linkVideoEnd - this.linkVideoStart)/this.videoduration)*100}%`);
        Polymer.Base.async(function() {
          this.$$('#start-play-time').setAttribute('style', `left: ${(this.linkVideoStart/this.videoduration)*100}%;`);
          this.$$('#end-play-time').setAttribute('style', `left: ${(this.linkVideoEnd/this.videoduration)*100}%`);
        }.bind(this), 100)
      },

      changeShowLinkVideoTime: function() {
        var elPlayTime = this.$$('#linking-play-time');
        elPlayTime.setAttribute('style', `left: ${(this.showLinkingVideoStart/this.videoduration)*100}%; width: ${((this.showLinkingVideoEnd - this.showLinkingVideoStart)/this.videoduration)*100}%`);
        Polymer.Base.async(function(){
          if (this.$$('#start-play-time')) this.$$('#start-play-time').setAttribute('style', `left: ${(this.showLinkingVideoStart/this.videoduration)*100}%;`);
          if (this.$$('#end-play-time')) this.$$('#end-play-time').setAttribute('style', `left: ${(this.showLinkingVideoEnd/this.videoduration)*100}%`);
        }.bind(this), 100)
      },

      changeDiscussionTime: function() {
        var elPlayTime = this.$$('#discussion-play-time');
        elPlayTime.setAttribute('style', `left: ${(this.discussionstart/this.videoduration)*100}%; width: ${((this.discussionend - this.discussionstart)/this.videoduration)*100}%`);

        this.emitAction({
          type: KORERO.Actions.CHANGE_DISCUSSION_TIME,
          data: {discussionstart: this.discussionstart, discussionend: this.discussionend}
        })

        Polymer.Base.async(function(){
          this.$$('#start-play-time').setAttribute('style', `left: ${(this.discussionstart/this.videoduration)*100}%`);
          this.$$('#end-play-time').setAttribute('style', `left: ${(this.discussionend/this.videoduration)*100}%`);
        }.bind(this), 100)
      },

      _changeCommentTime: function() {
        var elPlayTime = this.$$('#comment-play-time');
        elPlayTime.setAttribute('style', `left: ${(this.commentstart/this.videoduration)*100}%; width: ${((this.commentend - this.commentstart)/this.videoduration)*100}%`);

        this.emitAction({
          type: KORERO.Actions.CHANGE_COMMENT_TIME,
          data: {discussionid: this.commentdiscussionid , commentstart: this.commentstart, commentend: this.commentend}
        })

        // this.fire('change-comment-time', {discussionid: this.commentdiscussionid , commentstart: this.commentstart, commentend: this.commentend});

        Polymer.Base.async(function(){
          this.$$('#start-play-time').setAttribute('style', `left: ${(this.commentstart/this.videoduration)*100}%`);
          this.$$('#end-play-time').setAttribute('style', `left: ${(this.commentend/this.videoduration)*100}%`);
        }.bind(this), 100)
      },

      changeSpecificTime: function() {
        var elPlayTime = this.$$('#specific-play-time');
        elPlayTime.setAttribute('style', `left: ${(this.playstart/this.videoduration)*100}%; width: ${((this.playend - this.playstart)/this.videoduration)*100}%`);
      },

      // check first
      _setCanvas: function(boxes, editable) {

      },

      newDiscussion: function(flag) {
        this.pause();
        this.discussionlink = true;
        this.discussionstart = this.videotime;
        this.discussionend = this.videotime;
        if (this.ui === 'adi') {
          this.discussionstart = this.videotime;
          this.discussionend = this.videotime;
          // this.discussionend = this.discussionstart + (this.videoduration * 0.05);
          this.visualstart = this._timeToString(this.discussionstart);
          this.visualend = this._timeToString(this.discussionend);
          this.changeDiscussionTime();
          this.$$('#video-content').seekTo(this.discussionstart);
        }
      },

      newComment: function(data) {
        this.commentdiscussionid = data.discussionid;
        this.pause();
        this.commentlink = true;
        this.commentstart = this.videotime;
        this.commentend = this.videotime;
        this.visualstart = this._timeToString(this.commentstart);
        this.visualend = this._timeToString(this.commentend);
        this.changeCommentTime();
        this.$$('#video-content').seekTo(this.commentstart);
      },

      closeComment: function() {
        this.commentlink = false;
        this.commentstart = null;
        this.commentend = null;
        this.visualend = null;
        this.visualstart = null;
        var elPlayTime = this.$$('#comment-play-time');
        elPlayTime.setAttribute('style', `left: 0; width: 0%`);
      },

      closeDiscussion: function() {
        this.discussionlink = false;
        this.discussionstart = null;
        this.discussionend = null;
        this.visualend = null;
        this.visualstart = null;
        var elPlayTime = this.$$('#discussion-play-time');
        elPlayTime.setAttribute('style', `left: 0; width: 0%`);
      },

      // called by discussion block... the playTime.start and end should be set there
      playSpecific: function(data) {
        console.log('playspecific')
        if (data.videostart != undefined || data.videostart != null) {
          this.$$('#video-content').seekTo(data.videostart);
          this.playspecific = true;
          this.playstart = data.videostart;
          this.playend = data.videoend;
          this.changeSpecificTime();
        } else {
          this.playspecific = false;
          this.playstart = null
          this.playend = null
          var elPlayTime = this.$$('#specific-play-time');
          elPlayTime.setAttribute('style', `left: 0; width: 0`);
        }
      },

      cancelSpecific: function() {
        this.playspecific = false;
        this.playstart = null
        this.playend = null
        var elPlayTime = this.$$('#specific-play-time');
        elPlayTime.setAttribute('style', `left: 0; width: 0`);
      },

      checkGeneral: function(linkVideoStart, linkingEdit) {
        // console.log(linkVideoStart, linkingEdit, linkingEdit && !linkVideoStart, !(linkVideoStart >= 0))
        return linkingEdit && (linkVideoStart == undefined || linkVideoStart == null);
      },

      startLinking: function(data) {
        this.pause();
        this.discussionid = data.discussionid
        this.linking = true;
        this.linkingEdit = true;
        this.linkVideoStart = null;
        this.linkVideoEnd = null;
        this.visualstart = this._timeToString(0);
        this.visualend = this._timeToString(this.videoduration);
        this.changeLinkVideoTime();
        this.async(function(){
          if (this.$$('#start-play-time')) {
            this.$$('#start-play-time').setAttribute('style', `left: 0%;`);
          }
          if (this.$$('#end-play-time')) {
            this.$$('#end-play-time').setAttribute('style', `left: 100%`);
          }
        }.bind(this), 300)

        // this.linkVideoStart = this.videotime;
        // this.linkVideoEnd = this.linkVideoStart + (this.videoduration * 0.05);
        // this.visualstart = this._timeToString(this.linkVideoStart);
        // this.visualend = this._timeToString(this.linkVideoEnd);
        // this.changeLinkVideoTime();
      },

      showLinking: function(start, end, tap) {
        console.log(start, end)
        this.showLinkingFlag = true;
        if (start && end) {
          this.showLinkingVideoStart = start;
          this.showLinkingVideoEnd = end;
          this.linkTapped = tap;
          this.changeShowLinkVideoTime();
          this.$$('#video-content').seekTo(this.showLinkingVideoStart);
        } else {
          this.$$('#video-content').seekTo(0)
        }
        this.play();
      },

      resetShowLinking: function() {
        if (!this.linkTapped) {
          this.showLinkingVideoStart = null;
          this.showLinkingVideoEnd = null;
          this.showLinkingFlag = false;
          var elPlayTime = this.$$('#show-linking-play-time');
          elPlayTime.setAttribute('style', `left: 0; width: 0`);
          this.pause();
        }
      },

      saveLinking: function() {
        var obj = {video: this.video.videoId}
        if (this.linkVideoStart) {
          obj.videostart = this.linkVideoStart
        }
        if (this.linkVideoEnd) {
          obj.videoend = this.linkVideoEnd;
          if (!this.linkVideoStart) {
            obj.videostart = 0;
          }
        }
        if (this.discussionid) {
          obj.discussionid = this.discussionid
        }
        this.emitAction({
          type: KORERO.Actions.SAVE_LINKING,
          data: obj
        })
        this.resetLinking();
        this.linking = false
      },

      addSegment: function() {
        var obj = {video: this.video.videoId}
        if (this.linkVideoStart) {
          obj.videostart = this.linkVideoStart
        }
        if (this.linkVideoEnd) {
          obj.videoend = this.linkVideoEnd;
          if (!this.linkVideoStart) {
            obj.videostart = 0;
          }
        }
        if (this.discussionid) {
          obj.discussionid = this.discussionid
        }
        this.emitAction({
          type: KORERO.Actions.SAVE_LINKING,
          data: obj
        })
        this.linkVideoStart = this.videotime;
        this.linkVideoEnd = this.videotime;
        this.visualend = this.videotime;
        this.visualstart = this.videotime;
        this.visualstart = this._timeToString(this.videotime);
        this.visualend = this._timeToString(this.videotime);
        this.changeLinkVideoTime();
        // this.$$('#start-play-time').setAttribute('style', `left: 0%;`);
        // this.$$('#end-play-time').setAttribute('style', `left: 100%`);
        this.pause();
      },

      cancelLinking: function() {
        this.emitAction({
          type: KORERO.Actions.CANCEL_LINKING
        });
        this.linkTapped = false;
        this.visualend = null;
        this.visualstart = null;
        this.resetLinking();
        this.linking = false;
      },

      resetLinking: function() {
        if (!this.linkTapped) {
          this.linkVideoStart = 0;
          this.linkVideoEnd = 0;
          this.linking = false;
          this.linkingEdit = false
          this.visualend = null;
          this.visualstart = null;
          var elPlayTime = this.$$('#linking-play-time');
          elPlayTime.setAttribute('style', `left: 0; width: 0`);
          this.pause();
        }
      }

    });
  </script>
</dom-module>
